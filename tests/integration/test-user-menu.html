<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Menu Component Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-section h2 {
            margin-top: 0;
            color: #2d3748;
        }

        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        button:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .status {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 10px;
        }

        .status.success {
            background: #d4f4dd;
            color: #22543d;
        }

        .status.info {
            background: #e6f7ff;
            color: #004085;
        }

        .status.error {
            background: #fed7d7;
            color: #742a2a;
        }

        .websocket-log {
            background: #1a202c;
            color: #68d391;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin: 5px 0;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .username-display {
            background: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .username-display strong {
            color: #4a5568;
        }

        .username-value {
            color: #2d3748;
            font-weight: 600;
            font-size: 18px;
        }

        .test-results {
            margin-top: 20px;
        }

        .test-result {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            background: #f7fafc;
            border-radius: 4px;
        }

        .test-result.pass {
            background: #d4f4dd;
        }

        .test-result.fail {
            background: #fed7d7;
        }

        .test-icon {
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🧪 User Menu Component Test</h1>
            <p>Test the username management and WebSocket integration</p>
        </div>

        <div class="test-section">
            <h2>📋 Current Username</h2>
            <div class="username-display">
                <strong>localStorage Username:</strong>
                <span class="username-value" id="currentUsername">Loading...</span>
            </div>
            <div class="test-controls">
                <button onclick="refreshUsername()">🔄 Refresh</button>
                <button onclick="setUsername()">✏️ Set Username</button>
                <button onclick="clearUsername()">🗑️ Clear Username</button>
                <button onclick="generateRandomUsername()">🎲 Random Username</button>
            </div>
            <div id="usernameStatus"></div>
        </div>

        <div class="test-section">
            <h2>🌐 WebSocket Connection Test</h2>
            <div class="test-controls">
                <button onclick="connectWebSocket()">🔗 Connect with Username</button>
                <button onclick="disconnectWebSocket()">❌ Disconnect</button>
                <button onclick="sendTestMessage()">📤 Send Test Message</button>
                <button onclick="clearLog()">🧹 Clear Log</button>
            </div>
            <div id="connectionStatus" class="status info">Not connected</div>
            <div class="websocket-log" id="wsLog"></div>
        </div>

        <div class="test-section">
            <h2>✅ Feature Tests</h2>
            <div class="test-controls">
                <button onclick="runAllTests()">🚀 Run All Tests</button>
            </div>
            <div class="test-results" id="testResults"></div>
        </div>

        <div class="test-section">
            <h2>🔄 Multi-User Simulation</h2>
            <div class="test-controls">
                <button onclick="simulateMultiUser()">👥 Simulate Multiple Users</button>
                <button onclick="testUserAttribution()">🏷️ Test Attribution</button>
            </div>
            <div id="multiUserStatus"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let messageCount = 0;

        // Initialize on load
        window.onload = () => {
            refreshUsername();
        };

        function refreshUsername() {
            const username = localStorage.getItem('username') || 'Not set';
            document.getElementById('currentUsername').textContent = username;
            updateStatus('usernameStatus', `Username: ${username}`, 'info');
        }

        function setUsername() {
            const newUsername = prompt('Enter new username:', localStorage.getItem('username') || '');
            if (newUsername && newUsername.trim()) {
                localStorage.setItem('username', newUsername.trim());
                refreshUsername();
                updateStatus('usernameStatus', `✅ Username updated to: ${newUsername.trim()}`, 'success');

                // Reconnect WebSocket if connected
                if (ws && ws.readyState === WebSocket.OPEN) {
                    disconnectWebSocket();
                    setTimeout(() => connectWebSocket(), 500);
                }
            }
        }

        function clearUsername() {
            if (confirm('Clear username from localStorage?')) {
                localStorage.removeItem('username');
                refreshUsername();
                updateStatus('usernameStatus', '✅ Username cleared', 'success');
            }
        }

        function generateRandomUsername() {
            const adjectives = ['Happy', 'Swift', 'Bright', 'Cool', 'Smart'];
            const nouns = ['Coder', 'Developer', 'Engineer', 'Builder', 'Creator'];
            const randomUsername = `${adjectives[Math.floor(Math.random() * adjectives.length)]}${nouns[Math.floor(Math.random() * nouns.length)]}${Math.floor(Math.random() * 1000)}`;

            localStorage.setItem('username', randomUsername);
            refreshUsername();
            updateStatus('usernameStatus', `✅ Generated username: ${randomUsername}`, 'success');
        }

        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                updateStatus('connectionStatus', '⚠️ Already connected', 'info');
                return;
            }

            const username = localStorage.getItem('username') || `User${Math.floor(Math.random() * 10000)}`;
            const wsUrl = `ws://localhost:18000/ws/connect?username=${encodeURIComponent(username)}`;

            logMessage(`🔗 Connecting as "${username}"...`);

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                updateStatus('connectionStatus', `✅ Connected as ${username}`, 'success');
                logMessage('✅ WebSocket connected');
            };

            ws.onmessage = (event) => {
                messageCount++;
                try {
                    const message = JSON.parse(event.data);

                    // Skip heartbeats for cleaner logs
                    if (message.event === 'heartbeat') {
                        return;
                    }

                    if (message.event === 'connected') {
                        logMessage(`📡 Connection confirmed - Username: ${message.data.username}, Client ID: ${message.data.client_id}`);
                    } else {
                        logMessage(`📨 Message #${messageCount}: ${JSON.stringify(message, null, 2)}`);
                    }
                } catch (error) {
                    logMessage(`📨 Raw message: ${event.data}`);
                }
            };

            ws.onerror = (error) => {
                updateStatus('connectionStatus', '❌ Connection error', 'error');
                logMessage(`❌ Error: ${error}`);
            };

            ws.onclose = () => {
                updateStatus('connectionStatus', '❌ Disconnected', 'error');
                logMessage('❌ WebSocket disconnected');
                ws = null;
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
                updateStatus('connectionStatus', '✅ Disconnected by user', 'info');
            } else {
                updateStatus('connectionStatus', '⚠️ Not connected', 'info');
            }
        }

        function sendTestMessage() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const testMessage = {
                    type: 'test',
                    data: {
                        username: localStorage.getItem('username'),
                        timestamp: new Date().toISOString()
                    }
                };
                ws.send(JSON.stringify(testMessage));
                logMessage(`📤 Sent: ${JSON.stringify(testMessage)}`);
            } else {
                updateStatus('connectionStatus', '⚠️ Not connected', 'error');
            }
        }

        function clearLog() {
            document.getElementById('wsLog').innerHTML = '';
            messageCount = 0;
        }

        function logMessage(message) {
            const log = document.getElementById('wsLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        async function runAllTests() {
            const results = document.getElementById('testResults');
            results.innerHTML = '';

            const tests = [
                {
                    name: 'localStorage Support',
                    test: () => {
                        try {
                            localStorage.setItem('test', 'value');
                            const value = localStorage.getItem('test');
                            localStorage.removeItem('test');
                            return value === 'value';
                        } catch {
                            return false;
                        }
                    }
                },
                {
                    name: 'Username Persistence',
                    test: () => {
                        const testName = 'TestUser123';
                        localStorage.setItem('username', testName);
                        const retrieved = localStorage.getItem('username');
                        return retrieved === testName;
                    }
                },
                {
                    name: 'WebSocket Support',
                    test: () => typeof WebSocket !== 'undefined'
                },
                {
                    name: 'Username in URL Encoding',
                    test: () => {
                        const username = 'Test User@123';
                        const encoded = encodeURIComponent(username);
                        return encoded === 'Test%20User%40123';
                    }
                },
                {
                    name: 'Default Username Generation',
                    test: () => {
                        const username = `User${Math.floor(Math.random() * 10000)}`;
                        return username.startsWith('User') && username.length > 4;
                    }
                }
            ];

            for (const test of tests) {
                const result = document.createElement('div');
                result.className = 'test-result';

                try {
                    const passed = await test.test();
                    result.className += passed ? ' pass' : ' fail';
                    result.innerHTML = `
                        <span class="test-icon">${passed ? '✅' : '❌'}</span>
                        <span>${test.name}: ${passed ? 'PASSED' : 'FAILED'}</span>
                    `;
                } catch (error) {
                    result.className += ' fail';
                    result.innerHTML = `
                        <span class="test-icon">❌</span>
                        <span>${test.name}: ERROR - ${error.message}</span>
                    `;
                }

                results.appendChild(result);
            }
        }

        function simulateMultiUser() {
            const status = document.getElementById('multiUserStatus');
            status.innerHTML = '<div class="status info">Simulating multiple users...</div>';

            const users = ['Alice', 'Bob', 'Charlie'];
            const connections = [];

            users.forEach((username, index) => {
                setTimeout(() => {
                    const wsUrl = `ws://localhost:18000/ws/connect?username=${encodeURIComponent(username)}`;
                    const userWs = new WebSocket(wsUrl);

                    userWs.onopen = () => {
                        status.innerHTML += `<div class="status success">✅ ${username} connected</div>`;
                    };

                    userWs.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        if (message.event === 'connected') {
                            status.innerHTML += `<div class="status info">📡 ${username} confirmed: ${message.data.username}</div>`;
                        }
                    };

                    connections.push(userWs);

                    // Close after 5 seconds
                    setTimeout(() => {
                        userWs.close();
                        status.innerHTML += `<div class="status info">👋 ${username} disconnected</div>`;
                    }, 5000);
                }, index * 1000);
            });
        }

        async function testUserAttribution() {
            const status = document.getElementById('multiUserStatus');
            status.innerHTML = '<div class="status info">Testing user attribution...</div>';

            try {
                // Create a ticket with attribution
                const response = await fetch('http://localhost:18000/api/tickets/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: `Test Ticket by ${localStorage.getItem('username')}`,
                        description: 'Testing user attribution',
                        board_id: 1,
                        current_column: 'Not Started',
                        created_by: localStorage.getItem('username')
                    })
                });

                if (response.ok) {
                    const ticket = await response.json();
                    status.innerHTML += `<div class="status success">✅ Ticket created with ID: ${ticket.id}</div>`;

                    // Move the ticket
                    const moveResponse = await fetch(`http://localhost:18000/api/tickets/${ticket.id}/move`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            column: 'In Progress',
                            moved_by: localStorage.getItem('username')
                        })
                    });

                    if (moveResponse.ok) {
                        status.innerHTML += `<div class="status success">✅ Ticket moved by ${localStorage.getItem('username')}</div>`;
                    }

                    // Clean up
                    await fetch(`http://localhost:18000/api/tickets/${ticket.id}`, {
                        method: 'DELETE'
                    });
                    status.innerHTML += `<div class="status info">🧹 Test ticket cleaned up</div>`;
                } else {
                    status.innerHTML += `<div class="status error">❌ Failed to create ticket</div>`;
                }
            } catch (error) {
                status.innerHTML += `<div class="status error">❌ Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
